import { bind } from 'angular2/src/core/di';
import { Json, isPresent, isBlank, StringWrapper } from 'angular2/src/facade/lang';
import { BaseException } from 'angular2/src/facade/exceptions';
import { WebDriverExtension, PerfLogFeatures } from '../web_driver_extension';
import { WebDriverAdapter } from '../web_driver_adapter';
export class IOsDriverExtension extends WebDriverExtension {
    constructor(_driver) {
        super();
        this._driver = _driver;
    }
    // TODO(tbosch): use static values when our transpiler supports them
    static get BINDINGS() { return _PROVIDERS; }
    gc() { throw new BaseException('Force GC is not supported on iOS'); }
    timeBegin(name) {
        return this._driver.executeScript(`console.time('${name}');`);
    }
    timeEnd(name, restartName = null) {
        var script = `console.timeEnd('${name}');`;
        if (isPresent(restartName)) {
            script += `console.time('${restartName}');`;
        }
        return this._driver.executeScript(script);
    }
    // See https://github.com/WebKit/webkit/tree/master/Source/WebInspectorUI/Versions
    readPerfLog() {
        // TODO(tbosch): Bug in IOsDriver: Need to execute at least one command
        // so that the browser logs can be read out!
        return this._driver.executeScript('1+1')
            .then((_) => this._driver.logs('performance'))
            .then((entries) => {
            var records = [];
            entries.forEach(entry => {
                var message = Json.parse(entry['message'])['message'];
                if (StringWrapper.equals(message['method'], 'Timeline.eventRecorded')) {
                    records.push(message['params']['record']);
                }
            });
            return this._convertPerfRecordsToEvents(records);
        });
    }
    _convertPerfRecordsToEvents(records, events = null) {
        if (isBlank(events)) {
            events = [];
        }
        records.forEach((record) => {
            var endEvent = null;
            var type = record['type'];
            var data = record['data'];
            var startTime = record['startTime'];
            var endTime = record['endTime'];
            if (StringWrapper.equals(type, 'FunctionCall') &&
                (isBlank(data) || !StringWrapper.equals(data['scriptName'], 'InjectedScript'))) {
                events.push(createStartEvent('script', startTime));
                endEvent = createEndEvent('script', endTime);
            }
            else if (StringWrapper.equals(type, 'Time')) {
                events.push(createMarkStartEvent(data['message'], startTime));
            }
            else if (StringWrapper.equals(type, 'TimeEnd')) {
                events.push(createMarkEndEvent(data['message'], startTime));
            }
            else if (StringWrapper.equals(type, 'RecalculateStyles') ||
                StringWrapper.equals(type, 'Layout') ||
                StringWrapper.equals(type, 'UpdateLayerTree') ||
                StringWrapper.equals(type, 'Paint') || StringWrapper.equals(type, 'Rasterize') ||
                StringWrapper.equals(type, 'CompositeLayers')) {
                events.push(createStartEvent('render', startTime));
                endEvent = createEndEvent('render', endTime);
            }
            // Note: ios used to support GCEvent up until iOS 6 :-(
            if (isPresent(record['children'])) {
                this._convertPerfRecordsToEvents(record['children'], events);
            }
            if (isPresent(endEvent)) {
                events.push(endEvent);
            }
        });
        return events;
    }
    perfLogFeatures() { return new PerfLogFeatures({ render: true }); }
    supports(capabilities) {
        return StringWrapper.equals(capabilities['browserName'].toLowerCase(), 'safari');
    }
}
function createEvent(ph, name, time, args = null) {
    var result = {
        'cat': 'timeline',
        'name': name,
        'ts': time,
        'ph': ph,
        // The ios protocol does not support the notions of multiple processes in
        // the perflog...
        'pid': 'pid0'
    };
    if (isPresent(args)) {
        result['args'] = args;
    }
    return result;
}
function createStartEvent(name, time, args = null) {
    return createEvent('B', name, time, args);
}
function createEndEvent(name, time, args = null) {
    return createEvent('E', name, time, args);
}
function createMarkStartEvent(name, time) {
    return createEvent('b', name, time);
}
function createMarkEndEvent(name, time) {
    return createEvent('e', name, time);
}
var _PROVIDERS = [
    bind(IOsDriverExtension)
        .toFactory((driver) => new IOsDriverExtension(driver), [WebDriverAdapter])
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW9zX2RyaXZlcl9leHRlbnNpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJiZW5jaHByZXNzL3NyYy93ZWJkcml2ZXIvaW9zX2RyaXZlcl9leHRlbnNpb24udHMiXSwibmFtZXMiOlsiSU9zRHJpdmVyRXh0ZW5zaW9uIiwiSU9zRHJpdmVyRXh0ZW5zaW9uLmNvbnN0cnVjdG9yIiwiSU9zRHJpdmVyRXh0ZW5zaW9uLkJJTkRJTkdTIiwiSU9zRHJpdmVyRXh0ZW5zaW9uLmdjIiwiSU9zRHJpdmVyRXh0ZW5zaW9uLnRpbWVCZWdpbiIsIklPc0RyaXZlckV4dGVuc2lvbi50aW1lRW5kIiwiSU9zRHJpdmVyRXh0ZW5zaW9uLnJlYWRQZXJmTG9nIiwiSU9zRHJpdmVyRXh0ZW5zaW9uLl9jb252ZXJ0UGVyZlJlY29yZHNUb0V2ZW50cyIsIklPc0RyaXZlckV4dGVuc2lvbi5wZXJmTG9nRmVhdHVyZXMiLCJJT3NEcml2ZXJFeHRlbnNpb24uc3VwcG9ydHMiLCJjcmVhdGVFdmVudCIsImNyZWF0ZVN0YXJ0RXZlbnQiLCJjcmVhdGVFbmRFdmVudCIsImNyZWF0ZU1hcmtTdGFydEV2ZW50IiwiY3JlYXRlTWFya0VuZEV2ZW50Il0sIm1hcHBpbmdzIjoiT0FBTyxFQUFDLElBQUksRUFBb0IsTUFBTSxzQkFBc0I7T0FDckQsRUFBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBaUIsYUFBYSxFQUFDLE1BQU0sMEJBQTBCO09BQ3hGLEVBQUMsYUFBYSxFQUFtQixNQUFNLGdDQUFnQztPQUV2RSxFQUFDLGtCQUFrQixFQUFFLGVBQWUsRUFBQyxNQUFNLHlCQUF5QjtPQUNwRSxFQUFDLGdCQUFnQixFQUFDLE1BQU0sdUJBQXVCO0FBR3RELHdDQUF3QyxrQkFBa0I7SUFJeERBLFlBQW9CQSxPQUF5QkE7UUFBSUMsT0FBT0EsQ0FBQ0E7UUFBckNBLFlBQU9BLEdBQVBBLE9BQU9BLENBQWtCQTtJQUFhQSxDQUFDQTtJQUgzREQsb0VBQW9FQTtJQUNwRUEsV0FBV0Es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LElBQUk7SUFDdENDLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLEdBQUdBLEVBQUVBLElBQUlBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO0FBQ3RDQSxDQUFDQTtBQUVELDRCQUE0QixJQUFJLEVBQUUsSUFBSTtJQUNwQ0MsTUFBTUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsR0FBR0EsRUFBRUEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7QUFDdENBLENBQUNBO0FBRUQsSUFBSSxVQUFVLEdBQUc7SUFDZixJQUFJLENBQUMsa0JBQWtCLENBQUM7U0FDbkIsU0FBUyxDQUFDLENBQUMsTUFBTSxLQUFLLElBQUksa0JBQWtCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0NBQy9FLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2JpbmQsIHByb3ZpZGUsIFByb3ZpZGVyfSBmcm9tICdhbmd1bGFyMi9zcmMvY29yZS9kaSc7XG5pbXBvcnQge0pzb24sIGlzUHJlc2VudCwgaXNCbGFuaywgUmVnRXhwV3JhcHBlciwgU3RyaW5nV3JhcHBlcn0gZnJvbSAnYW5ndWxhcjIvc3JjL2ZhY2FkZS9sYW5nJztcbmltcG9ydCB7QmFzZUV4Y2VwdGlvbiwgV3JhcHBlZEV4Y2VwdGlvbn0gZnJvbSAnYW5ndWxhcjIvc3JjL2ZhY2FkZS9leGNlcHRpb25zJztcblxuaW1wb3J0IHtXZWJEcml2ZXJFeHRlbnNpb24sIFBlcmZMb2dGZWF0dXJlc30gZnJvbSAnLi4vd2ViX2RyaXZlcl9leHRlbnNpb24nO1xuaW1wb3J0IHtXZWJEcml2ZXJBZGFwdGVyfSBmcm9tICcuLi93ZWJfZHJpdmVyX2FkYXB0ZXInO1xuaW1wb3J0IHtQcm9taXNlfSBmcm9tICdhbmd1bGFyMi9zcmMvZmFjYWRlL2FzeW5jJztcblxuZXhwb3J0IGNsYXNzIElPc0RyaXZlckV4dGVuc2lvbiBleHRlbmRzIFdlYkRyaXZlckV4dGVuc2lvbiB7XG4gIC8vIFRPRE8odGJvc2NoKTogdXNlIHN0YXRpYyB2YWx1ZXMgd2hlbiBvdXIgdHJhbnNwaWxlciBzdXBwb3J0cyB0aGVtXG4gIHN0YXRpYyBnZXQgQklORElOR1MoKTogUHJvdmlkZXJbXSB7IHJldHVybiBfUFJPVklERVJTOyB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZHJpdmVyOiBXZWJEcml2ZXJBZGFwdGVyKSB7IHN1cGVyKCk7IH1cblxuICBnYygpOiBQcm9taXNlPGFueT4geyB0aHJvdyBuZXcgQmFzZUV4Y2VwdGlvbignRm9yY2UgR0MgaXMgbm90IHN1cHBvcnRlZCBvbiBpT1MnKTsgfVxuXG4gIHRpbWVCZWdpbihuYW1lOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLl9kcml2ZXIuZXhlY3V0ZVNjcmlwdChgY29uc29sZS50aW1lKCcke25hbWV9Jyk7YCk7XG4gIH1cblxuICB0aW1lRW5kKG5hbWU6IHN0cmluZywgcmVzdGFydE5hbWU6IHN0cmluZyA9IG51bGwpOiBQcm9taXNlPGFueT4ge1xuICAgIHZhciBzY3JpcHQgPSBgY29uc29sZS50aW1lRW5kKCcke25hbWV9Jyk7YDtcbiAgICBpZiAoaXNQcmVzZW50KHJlc3RhcnROYW1lKSkge1xuICAgICAgc2NyaXB0ICs9IGBjb25zb2xlLnRpbWUoJyR7cmVzdGFydE5hbWV9Jyk7YFxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fZHJpdmVyLmV4ZWN1dGVTY3JpcHQoc2NyaXB0KTtcbiAgfVxuXG4gIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vV2ViS2l0L3dlYmtpdC90cmVlL21hc3Rlci9Tb3VyY2UvV2ViSW5zcGVjdG9yVUkvVmVyc2lvbnNcbiAgcmVhZFBlcmZMb2coKSB7XG4gICAgLy8gVE9ETyh0Ym9zY2gpOiBCdWcgaW4gSU9zRHJpdmVyOiBOZWVkIHRvIGV4ZWN1dGUgYXQgbGVhc3Qgb25lIGNvbW1hbmRcbiAgICAvLyBzbyB0aGF0IHRoZSBicm93c2VyIGxvZ3MgY2FuIGJlIHJlYWQgb3V0IVxuICAgIHJldHVybiB0aGlzLl9kcml2ZXIuZXhlY3V0ZVNjcmlwdCgnMSsxJylcbiAgICAgICAgLnRoZW4oKF8pID0+IHRoaXMuX2RyaXZlci5sb2dzKCdwZXJmb3JtYW5jZScpKVxuICAgICAgICAudGhlbigoZW50cmllcykgPT4ge1xuICAgICAgICAgIHZhciByZWNvcmRzID0gW107XG4gICAgICAgICAgZW50cmllcy5mb3JFYWNoKGVudHJ5ID0+IHtcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gSnNvbi5wYXJzZShlbnRyeVsnbWVzc2FnZSddKVsnbWVzc2FnZSddO1xuICAgICAgICAgICAgaWYgKFN0cmluZ1dyYXBwZXIuZXF1YWxzKG1lc3NhZ2VbJ21ldGhvZCddLCAnVGltZWxpbmUuZXZlbnRSZWNvcmRlZCcpKSB7XG4gICAgICAgICAgICAgIHJlY29yZHMucHVzaChtZXNzYWdlWydwYXJhbXMnXVsncmVjb3JkJ10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiB0aGlzLl9jb252ZXJ0UGVyZlJlY29yZHNUb0V2ZW50cyhyZWNvcmRzKTtcbiAgICAgICAgfSk7XG4gIH1cblxuICBfY29udmVydFBlcmZSZWNvcmRzVG9FdmVudHMocmVjb3JkczogYW55W10sIGV2ZW50czogYW55W10gPSBudWxsKSB7XG4gICAgaWYgKGlzQmxhbmsoZXZlbnRzKSkge1xuICAgICAgZXZlbnRzID0gW107XG4gICAgfVxuICAgIHJlY29yZHMuZm9yRWFjaCgocmVjb3JkKSA9PiB7XG4gICAgICB2YXIgZW5kRXZlbnQgPSBudWxsO1xuICAgICAgdmFyIHR5cGUgPSByZWNvcmRbJ3R5cGUnXTtcbiAgICAgIHZhciBkYXRhID0gcmVjb3JkWydkYXRhJ107XG4gICAgICB2YXIgc3RhcnRUaW1lID0gcmVjb3JkWydzdGFydFRpbWUnXTtcbiAgICAgIHZhciBlbmRUaW1lID0gcmVjb3JkWydlbmRUaW1lJ107XG5cbiAgICAgIGlmIChTdHJpbmdXcmFwcGVyLmVxdWFscyh0eXBlLCAnRnVuY3Rpb25DYWxsJykgJiZcbiAgICAgICAgICAoaXNCbGFuayhkYXRhKSB8fCAhU3RyaW5nV3JhcHBlci5lcXVhbHMoZGF0YVsnc2NyaXB0TmFtZSddLCAnSW5qZWN0ZWRTY3JpcHQnKSkpIHtcbiAgICAgICAgZXZlbnRzLnB1c2goY3JlYXRlU3RhcnRFdmVudCgnc2NyaXB0Jywgc3RhcnRUaW1lKSk7XG4gICAgICAgIGVuZEV2ZW50ID0gY3JlYXRlRW5kRXZlbnQoJ3NjcmlwdCcsIGVuZFRpbWUpO1xuICAgICAgfSBlbHNlIGlmIChTdHJpbmdXcmFwcGVyLmVxdWFscyh0eXBlLCAnVGltZScpKSB7XG4gICAgICAgIGV2ZW50cy5wdXNoKGNyZWF0ZU1hcmtTdGFydEV2ZW50KGRhdGFbJ21lc3NhZ2UnXSwgc3RhcnRUaW1lKSk7XG4gICAgICB9IGVsc2UgaWYgKFN0cmluZ1dyYXBwZXIuZXF1YWxzKHR5cGUsICdUaW1lRW5kJykpIHtcbiAgICAgICAgZXZlbnRzLnB1c2goY3JlYXRlTWFya0VuZEV2ZW50KGRhdGFbJ21lc3NhZ2UnXSwgc3RhcnRUaW1lKSk7XG4gICAgICB9IGVsc2UgaWYgKFN0cmluZ1dyYXBwZXIuZXF1YWxzKHR5cGUsICdSZWNhbGN1bGF0ZVN0eWxlcycpIHx8XG4gICAgICAgICAgICAgICAgIFN0cmluZ1dyYXBwZXIuZXF1YWxzKHR5cGUsICdMYXlvdXQnKSB8fFxuICAgICAgICAgICAgICAgICBTdHJpbmdXcmFwcGVyLmVxdWFscyh0eXBlLCAnVXBkYXRlTGF5ZXJUcmVlJykgfHxcbiAgICAgICAgICAgICAgICAgU3RyaW5nV3JhcHBlci5lcXVhbHModHlwZSwgJ1BhaW50JykgfHwgU3RyaW5nV3JhcHBlci5lcXVhbHModHlwZSwgJ1Jhc3Rlcml6ZScpIHx8XG4gICAgICAgICAgICAgICAgIFN0cmluZ1dyYXBwZXIuZXF1YWxzKHR5cGUsICdDb21wb3NpdGVMYXllcnMnKSkge1xuICAgICAgICBldmVudHMucHVzaChjcmVhdGVTdGFydEV2ZW50KCdyZW5kZXInLCBzdGFydFRpbWUpKTtcbiAgICAgICAgZW5kRXZlbnQgPSBjcmVhdGVFbmRFdmVudCgncmVuZGVyJywgZW5kVGltZSk7XG4gICAgICB9XG4gICAgICAvLyBOb3RlOiBpb3MgdXNlZCB0byBzdXBwb3J0IEdDRXZlbnQgdXAgdW50aWwgaU9TIDYgOi0oXG4gICAgICBpZiAoaXNQcmVzZW50KHJlY29yZFsnY2hpbGRyZW4nXSkpIHtcbiAgICAgICAgdGhpcy5fY29udmVydFBlcmZSZWNvcmRzVG9FdmVudHMocmVjb3JkWydjaGlsZHJlbiddLCBldmVudHMpO1xuICAgICAgfVxuICAgICAgaWYgKGlzUHJlc2VudChlbmRFdmVudCkpIHtcbiAgICAgICAgZXZlbnRzLnB1c2goZW5kRXZlbnQpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBldmVudHM7XG4gIH1cblxuICBwZXJmTG9nRmVhdHVyZXMoKTogUGVyZkxvZ0ZlYXR1cmVzIHsgcmV0dXJuIG5ldyBQZXJmTG9nRmVhdHVyZXMoe3JlbmRlcjogdHJ1ZX0pOyB9XG5cbiAgc3VwcG9ydHMoY2FwYWJpbGl0aWVzOiB7W2tleTogc3RyaW5nXTogYW55fSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBTdHJpbmdXcmFwcGVyLmVxdWFscyhjYXBhYmlsaXRpZXNbJ2Jyb3dzZXJOYW1lJ10udG9Mb3dlckNhc2UoKSwgJ3NhZmFyaScpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUV2ZW50KHBoLCBuYW1lLCB0aW1lLCBhcmdzID0gbnVsbCkge1xuICB2YXIgcmVzdWx0ID0ge1xuICAgICdjYXQnOiAndGltZWxpbmUnLFxuICAgICduYW1lJzogbmFtZSxcbiAgICAndHMnOiB0aW1lLFxuICAgICdwaCc6IHBoLFxuICAgIC8vIFRoZSBpb3MgcHJvdG9jb2wgZG9lcyBub3Qgc3VwcG9ydCB0aGUgbm90aW9ucyBvZiBtdWx0aXBsZSBwcm9jZXNzZXMgaW5cbiAgICAvLyB0aGUgcGVyZmxvZy4uLlxuICAgICdwaWQnOiAncGlkMCdcbiAgfTtcbiAgaWYgKGlzUHJlc2VudChhcmdzKSkge1xuICAgIHJlc3VsdFsnYXJncyddID0gYXJncztcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVTdGFydEV2ZW50KG5hbWUsIHRpbWUsIGFyZ3MgPSBudWxsKSB7XG4gIHJldHVybiBjcmVhdGVFdmVudCgnQicsIG5hbWUsIHRpbWUsIGFyZ3MpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVFbmRFdmVudChuYW1lLCB0aW1lLCBhcmdzID0gbnVsbCkge1xuICByZXR1cm4gY3JlYXRlRXZlbnQoJ0UnLCBuYW1lLCB0aW1lLCBhcmdzKTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlTWFya1N0YXJ0RXZlbnQobmFtZSwgdGltZSkge1xuICByZXR1cm4gY3JlYXRlRXZlbnQoJ2InLCBuYW1lLCB0aW1lKTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlTWFya0VuZEV2ZW50KG5hbWUsIHRpbWUpIHtcbiAgcmV0dXJuIGNyZWF0ZUV2ZW50KCdlJywgbmFtZSwgdGltZSk7XG59XG5cbnZhciBfUFJPVklERVJTID0gW1xuICBiaW5kKElPc0RyaXZlckV4dGVuc2lvbilcbiAgICAgIC50b0ZhY3RvcnkoKGRyaXZlcikgPT4gbmV3IElPc0RyaXZlckV4dGVuc2lvbihkcml2ZXIpLCBbV2ViRHJpdmVyQWRhcHRlcl0pXG5dO1xuIl19