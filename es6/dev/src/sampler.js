import { isPresent, isBlank } from 'angular2/src/facade/lang';
import { PromiseWrapper } from 'angular2/src/facade/async';
import { bind } from 'angular2/src/core/di';
import { Metric } from './metric';
import { Validator } from './validator';
import { Reporter } from './reporter';
import { WebDriverAdapter } from './web_driver_adapter';
import { Options } from './common_options';
import { MeasureValues } from './measure_values';
/**
 * The Sampler owns the sample loop:
 * 1. calls the prepare/execute callbacks,
 * 2. gets data from the metric
 * 3. asks the validator for a valid sample
 * 4. reports the new data to the reporter
 * 5. loop until there is a valid sample
 */
export class Sampler {
    constructor({ driver, metric, reporter, validator, prepare, execute, now } = {}) {
        this._driver = driver;
        this._metric = metric;
        this._reporter = reporter;
        this._validator = validator;
        this._prepare = prepare;
        this._execute = execute;
        this._now = now;
    }
    // TODO(tbosch): use static values when our transpiler supports them
    static get BINDINGS() { return _PROVIDERS; }
    sample() {
        var loop;
        loop = (lastState) => {
            return this._iterate(lastState).then((newState) => {
                if (isPresent(newState.validSample)) {
                    return newState;
                }
                else {
                    return loop(newState);
                }
            });
        };
        return loop(new SampleState([], null));
    }
    _iterate(lastState) {
        var resultPromise;
        if (isPresent(this._prepare)) {
            resultPromise = this._driver.waitFor(this._prepare);
        }
        else {
            resultPromise = PromiseWrapper.resolve(null);
        }
        if (isPresent(this._prepare) || lastState.completeSample.length === 0) {
            resultPromise = resultPromise.then((_) => this._metric.beginMeasure());
        }
        return resultPromise.then((_) => this._driver.waitFor(this._execute))
            .then((_) => this._metric.endMeasure(isBlank(this._prepare)))
            .then((measureValues) => this._report(lastState, measureValues));
    }
    _report(state, metricValues) {
        var measureValues = new MeasureValues(state.completeSample.length, this._now(), metricValues);
        var completeSample = state.completeSample.concat([measureValues]);
        var validSample = this._validator.validate(completeSample);
        var resultPromise = this._reporter.reportMeasureValues(measureValues);
        if (isPresent(validSample)) {
            resultPromise =
                resultPromise.then((_) => this._reporter.reportSample(completeSample, validSample));
        }
        return resultPromise.then((_) => new SampleState(completeSample, validSample));
    }
}
export class SampleState {
    constructor(completeSample, validSample) {
        this.completeSample = completeSample;
        this.validSample = validSample;
    }
}
var _PROVIDERS = [
    bind(Sampler)
        .toFactory((driver, metric, reporter, validator, prepare, execute, now) => new Sampler({
        driver: driver,
        reporter: reporter,
        validator: validator,
        metric: metric,
        // TODO(tbosch): DI right now does not support null/undefined objects
        // Mostly because the cache would have to be initialized with a
        // special null object, which is expensive.
        prepare: prepare !== false ? prepare : null,
        execute: execute,
        now: now
    }), [
        WebDriverAdapter,
        Metric,
        Reporter,
        Validator,
        Options.PREPARE,
        Options.EXECUTE,
        Options.NOW
    ])
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FtcGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJlbmNocHJlc3Mvc3JjL3NhbXBsZXIudHMiXSwibmFtZXMiOlsiU2FtcGxlciIsIlNhbXBsZXIuY29uc3RydWN0b3IiLCJTYW1wbGVyLkJJTkRJTkdTIiwiU2FtcGxlci5zYW1wbGUiLCJTYW1wbGVyLl9pdGVyYXRlIiwiU2FtcGxlci5fcmVwb3J0IiwiU2FtcGxlU3RhdGUiLCJTYW1wbGVTdGF0ZS5jb25zdHJ1Y3RvciJdLCJtYXBwaW5ncyI6Ik9BQU8sRUFBQyxTQUFTLEVBQUUsT0FBTyxFQUFvQixNQUFNLDBCQUEwQjtPQUN2RSxFQUFVLGNBQWMsRUFBQyxNQUFNLDJCQUEyQjtPQUMxRCxFQUFDLElBQUksRUFBaUMsTUFBTSxzQkFBc0I7T0FFbEUsRUFBQyxNQUFNLEVBQUMsTUFBTSxVQUFVO09BQ3hCLEVBQUMsU0FBUyxFQUFDLE1BQU0sYUFBYTtPQUM5QixFQUFDLFFBQVEsRUFBQyxNQUFNLFlBQVk7T0FDNUIsRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLHNCQUFzQjtPQUU5QyxFQUFDLE9BQU8sRUFBQyxNQUFNLGtCQUFrQjtPQUNqQyxFQUFDLGFBQWEsRUFBQyxNQUFNLGtCQUFrQjtBQUU5Qzs7Ozs7OztHQU9HO0FBQ0g7SUFZRUEsWUFBWUEsRUFBQ0EsTUFBTUEsRUFBRUEsTUFBTUEsRUFBRUEsUUFBUUEsRUFBRUEsU0FBU0EsRUFBRUEsT0FBT0EsRUFBRUEsT0FBT0EsRUFBRUEsR0FBR0EsRUFBQ0EsR0FRcEVBLEVBQUVBO1FBQ0pDLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLE1BQU1BLENBQUNBO1FBQ3RCQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxNQUFNQSxDQUFDQTtRQUN0QkEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsUUFBUUEsQ0FBQ0E7UUFDMUJBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLFNBQVNBLENBQUNBO1FBQzVCQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFHQSxPQUFPQSxDQUFDQTtRQUN4QkEsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsT0FBT0EsQ0FBQ0E7UUFDeEJBLElBQUlBLENBQUNBLElBQUlBLEdBQUdBLEdBQUdBLENBQUNBO0lBQ2xCQSxDQUFDQTtJQTNCREQsb0VBQW9FQTtJQUNwRUEsV0FBV0EsUUFBUUEsS0FBaUJFLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBO0lBNEJ4REYsTUFBTUE7UUFDSkcsSUFBSUEsSUFBSUEsQ0FBQ0E7UUFDVEEsSUFBSUEsR0FBR0EsQ0FBQ0EsU0FBU0E7WUFDZkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsUUFBUUE7Z0JBQzVDQSxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQSxRQUFRQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDcENBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBO2dCQUNsQkEsQ0FBQ0E7Z0JBQUNBLElBQUlBLENBQUNBLENBQUNBO29CQUNOQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtnQkFDeEJBLENBQUNBO1lBQ0hBLENBQUNBLENBQUNBLENBQUNBO1FBQ0xBLENBQUNBLENBQUNBO1FBQ0ZBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLElBQUlBLFdBQVdBLENBQUNBLEVBQUVBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO0lBQ3pDQSxDQUFDQTtJQUVESCxRQUFRQSxDQUFDQSxTQUFTQTtRQUNoQkksSUFBSUEsYUFBYUEsQ0FBQ0E7UUFDbEJBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQzdCQSxhQUFhQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUN0REEsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDTkEsYUFBYUEsR0FBR0EsY0FBY0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDL0NBLENBQUNBO1FBQ0RBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLFNBQVNBLENBQUNBLGNBQWNBLENBQUNBLE1BQU1BLEtBQUtBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3RFQSxhQUFhQSxHQUFHQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxZQUFZQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUN6RUEsQ0FBQ0E7UUFDREEsTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7YUFDaEVBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO2FBQzVEQSxJQUFJQSxDQUFDQSxDQUFDQSxhQUFhQSxLQUFLQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxTQUFTQSxFQUFFQSxhQUFhQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUN2RUEsQ0FBQ0E7SUFFREosT0FBT0EsQ0FBQ0EsS0FBa0JBLEVBQUVBLFlBQWtDQTtRQUM1REssSUFBSUEsYUFBYUEsR0FBR0EsSUFBSUEsYUFBYUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsSUFBSUEsRUFBRUEsRUFBRUEsWUFBWUEsQ0FBQ0EsQ0FBQ0E7UUFDOUZBLElBQUlBLGNBQWNBLEdBQUdBLEtBQUtBLENBQUNBLGNBQWNBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLGFBQWFBLENBQUNBLENBQUNBLENBQUNBO1FBQ2xFQSxJQUFJQSxXQUFXQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQTtRQUMzREEsSUFBSUEsYUFBYUEsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQTtRQUN0RUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLGFBQWFBO2dCQUNUQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxZQUFZQSxDQUFDQSxjQUFjQSxFQUFFQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFBQTtRQUN6RkEsQ0FBQ0E7UUFDREEsTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsSUFBSUEsV0FBV0EsQ0FBQ0EsY0FBY0EsRUFBRUEsV0FBV0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDakZBLENBQUNBO0FBQ0hMLENBQUNBO0FBRUQ7SUFDRU0sWUFBbUJBLGNBQXFCQSxFQUFTQSxXQUFrQkE7UUFBaERDLG1CQUFjQSxHQUFkQSxjQUFjQSxDQUFPQTtRQUFTQSxnQkFBV0EsR0FBWEEsV0FBV0EsQ0FBT0E7SUFBR0EsQ0FBQ0E7QUFDekVELENBQUNBO0FBRUQsSUFBSSxVQUFVLEdBQUc7SUFDZixJQUFJLENBQUMsT0FBTyxDQUFDO1NBQ1IsU0FBUyxDQUFDLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxLQUFLLElBQUksT0FBTyxDQUFDO1FBQzFFLE1BQU0sRUFBRSxNQUFNO1FBQ2QsUUFBUSxFQUFFLFFBQVE7UUFDbEIsU0FBUyxFQUFFLFNBQVM7UUFDcEIsTUFBTSxFQUFFLE1BQU07UUFDZCxxRUFBcUU7UUFDckUsK0RBQStEO1FBQy9ELDJDQUEyQztRQUMzQyxPQUFPLEVBQUUsT0FBTyxLQUFLLEtBQUssR0FBRyxPQUFPLEdBQUcsSUFBSTtRQUMzQyxPQUFPLEVBQUUsT0FBTztRQUNoQixHQUFHLEVBQUUsR0FBRztLQUNULENBQUMsRUFDRjtRQUNFLGdCQUFnQjtRQUNoQixNQUFNO1FBQ04sUUFBUTtRQUNSLFNBQVM7UUFDVCxPQUFPLENBQUMsT0FBTztRQUNmLE9BQU8sQ0FBQyxPQUFPO1FBQ2YsT0FBTyxDQUFDLEdBQUc7S0FDWixDQUFDO0NBQ2xCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2lzUHJlc2VudCwgaXNCbGFuaywgRGF0ZSwgRGF0ZVdyYXBwZXJ9IGZyb20gJ2FuZ3VsYXIyL3NyYy9mYWNhZGUvbGFuZyc7XG5pbXBvcnQge1Byb21pc2UsIFByb21pc2VXcmFwcGVyfSBmcm9tICdhbmd1bGFyMi9zcmMvZmFjYWRlL2FzeW5jJztcbmltcG9ydCB7YmluZCwgcHJvdmlkZSwgUHJvdmlkZXIsIE9wYXF1ZVRva2VufSBmcm9tICdhbmd1bGFyMi9zcmMvY29yZS9kaSc7XG5cbmltcG9ydCB7TWV0cmljfSBmcm9tICcuL21ldHJpYyc7XG5pbXBvcnQge1ZhbGlkYXRvcn0gZnJvbSAnLi92YWxpZGF0b3InO1xuaW1wb3J0IHtSZXBvcnRlcn0gZnJvbSAnLi9yZXBvcnRlcic7XG5pbXBvcnQge1dlYkRyaXZlckFkYXB0ZXJ9IGZyb20gJy4vd2ViX2RyaXZlcl9hZGFwdGVyJztcblxuaW1wb3J0IHtPcHRpb25zfSBmcm9tICcuL2NvbW1vbl9vcHRpb25zJztcbmltcG9ydCB7TWVhc3VyZVZhbHVlc30gZnJvbSAnLi9tZWFzdXJlX3ZhbHVlcyc7XG5cbi8qKlxuICogVGhlIFNhbXBsZXIgb3ducyB0aGUgc2FtcGxlIGxvb3A6XG4gKiAxLiBjYWxscyB0aGUgcHJlcGFyZS9leGVjdXRlIGNhbGxiYWNrcyxcbiAqIDIuIGdldHMgZGF0YSBmcm9tIHRoZSBtZXRyaWNcbiAqIDMuIGFza3MgdGhlIHZhbGlkYXRvciBmb3IgYSB2YWxpZCBzYW1wbGVcbiAqIDQuIHJlcG9ydHMgdGhlIG5ldyBkYXRhIHRvIHRoZSByZXBvcnRlclxuICogNS4gbG9vcCB1bnRpbCB0aGVyZSBpcyBhIHZhbGlkIHNhbXBsZVxuICovXG5leHBvcnQgY2xhc3MgU2FtcGxlciB7XG4gIC8vIFRPRE8odGJvc2NoKTogdXNlIHN0YXRpYyB2YWx1ZXMgd2hlbiBvdXIgdHJhbnNwaWxlciBzdXBwb3J0cyB0aGVtXG4gIHN0YXRpYyBnZXQgQklORElOR1MoKTogUHJvdmlkZXJbXSB7IHJldHVybiBfUFJPVklERVJTOyB9XG5cbiAgX2RyaXZlcjogV2ViRHJpdmVyQWRhcHRlcjtcbiAgX21ldHJpYzogTWV0cmljO1xuICBfcmVwb3J0ZXI6IFJlcG9ydGVyO1xuICBfdmFsaWRhdG9yOiBWYWxpZGF0b3I7XG4gIF9wcmVwYXJlOiBGdW5jdGlvbjtcbiAgX2V4ZWN1dGU6IEZ1bmN0aW9uO1xuICBfbm93OiBGdW5jdGlvbjtcblxuICBjb25zdHJ1Y3Rvcih7ZHJpdmVyLCBtZXRyaWMsIHJlcG9ydGVyLCB2YWxpZGF0b3IsIHByZXBhcmUsIGV4ZWN1dGUsIG5vd306IHtcbiAgICBkcml2ZXI/OiBXZWJEcml2ZXJBZGFwdGVyLFxuICAgIG1ldHJpYz86IE1ldHJpYyxcbiAgICByZXBvcnRlcj86IFJlcG9ydGVyLFxuICAgIHZhbGlkYXRvcj86IFZhbGlkYXRvcixcbiAgICBwcmVwYXJlPzogRnVuY3Rpb24sXG4gICAgZXhlY3V0ZT86IEZ1bmN0aW9uLFxuICAgIG5vdz86IEZ1bmN0aW9uXG4gIH0gPSB7fSkge1xuICAgIHRoaXMuX2RyaXZlciA9IGRyaXZlcjtcbiAgICB0aGlzLl9tZXRyaWMgPSBtZXRyaWM7XG4gICAgdGhpcy5fcmVwb3J0ZXIgPSByZXBvcnRlcjtcbiAgICB0aGlzLl92YWxpZGF0b3IgPSB2YWxpZGF0b3I7XG4gICAgdGhpcy5fcHJlcGFyZSA9IHByZXBhcmU7XG4gICAgdGhpcy5fZXhlY3V0ZSA9IGV4ZWN1dGU7XG4gICAgdGhpcy5fbm93ID0gbm93O1xuICB9XG5cbiAgc2FtcGxlKCk6IFByb21pc2U8U2FtcGxlU3RhdGU+IHtcbiAgICB2YXIgbG9vcDtcbiAgICBsb29wID0gKGxhc3RTdGF0ZSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuX2l0ZXJhdGUobGFzdFN0YXRlKS50aGVuKChuZXdTdGF0ZSkgPT4ge1xuICAgICAgICBpZiAoaXNQcmVzZW50KG5ld1N0YXRlLnZhbGlkU2FtcGxlKSkge1xuICAgICAgICAgIHJldHVybiBuZXdTdGF0ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gbG9vcChuZXdTdGF0ZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH07XG4gICAgcmV0dXJuIGxvb3AobmV3IFNhbXBsZVN0YXRlKFtdLCBudWxsKSk7XG4gIH1cblxuICBfaXRlcmF0ZShsYXN0U3RhdGUpIHtcbiAgICB2YXIgcmVzdWx0UHJvbWlzZTtcbiAgICBpZiAoaXNQcmVzZW50KHRoaXMuX3ByZXBhcmUpKSB7XG4gICAgICByZXN1bHRQcm9taXNlID0gdGhpcy5fZHJpdmVyLndhaXRGb3IodGhpcy5fcHJlcGFyZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdFByb21pc2UgPSBQcm9taXNlV3JhcHBlci5yZXNvbHZlKG51bGwpO1xuICAgIH1cbiAgICBpZiAoaXNQcmVzZW50KHRoaXMuX3ByZXBhcmUpIHx8IGxhc3RTdGF0ZS5jb21wbGV0ZVNhbXBsZS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJlc3VsdFByb21pc2UgPSByZXN1bHRQcm9taXNlLnRoZW4oKF8pID0+IHRoaXMuX21ldHJpYy5iZWdpbk1lYXN1cmUoKSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRQcm9taXNlLnRoZW4oKF8pID0+IHRoaXMuX2RyaXZlci53YWl0Rm9yKHRoaXMuX2V4ZWN1dGUpKVxuICAgICAgICAudGhlbigoXykgPT4gdGhpcy5fbWV0cmljLmVuZE1lYXN1cmUoaXNCbGFuayh0aGlzLl9wcmVwYXJlKSkpXG4gICAgICAgIC50aGVuKChtZWFzdXJlVmFsdWVzKSA9PiB0aGlzLl9yZXBvcnQobGFzdFN0YXRlLCBtZWFzdXJlVmFsdWVzKSk7XG4gIH1cblxuICBfcmVwb3J0KHN0YXRlOiBTYW1wbGVTdGF0ZSwgbWV0cmljVmFsdWVzOiB7W2tleTogc3RyaW5nXTogYW55fSk6IFByb21pc2U8U2FtcGxlU3RhdGU+IHtcbiAgICB2YXIgbWVhc3VyZVZhbHVlcyA9IG5ldyBNZWFzdXJlVmFsdWVzKHN0YXRlLmNvbXBsZXRlU2FtcGxlLmxlbmd0aCwgdGhpcy5fbm93KCksIG1ldHJpY1ZhbHVlcyk7XG4gICAgdmFyIGNvbXBsZXRlU2FtcGxlID0gc3RhdGUuY29tcGxldGVTYW1wbGUuY29uY2F0KFttZWFzdXJlVmFsdWVzXSk7XG4gICAgdmFyIHZhbGlkU2FtcGxlID0gdGhpcy5fdmFsaWRhdG9yLnZhbGlkYXRlKGNvbXBsZXRlU2FtcGxlKTtcbiAgICB2YXIgcmVzdWx0UHJvbWlzZSA9IHRoaXMuX3JlcG9ydGVyLnJlcG9ydE1lYXN1cmVWYWx1ZXMobWVhc3VyZVZhbHVlcyk7XG4gICAgaWYgKGlzUHJlc2VudCh2YWxpZFNhbXBsZSkpIHtcbiAgICAgIHJlc3VsdFByb21pc2UgPVxuICAgICAgICAgIHJlc3VsdFByb21pc2UudGhlbigoXykgPT4gdGhpcy5fcmVwb3J0ZXIucmVwb3J0U2FtcGxlKGNvbXBsZXRlU2FtcGxlLCB2YWxpZFNhbXBsZSkpXG4gICAgfVxuICAgIHJldHVybiByZXN1bHRQcm9taXNlLnRoZW4oKF8pID0+IG5ldyBTYW1wbGVTdGF0ZShjb21wbGV0ZVNhbXBsZSwgdmFsaWRTYW1wbGUpKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2FtcGxlU3RhdGUge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgY29tcGxldGVTYW1wbGU6IGFueVtdLCBwdWJsaWMgdmFsaWRTYW1wbGU6IGFueVtdKSB7fVxufVxuXG52YXIgX1BST1ZJREVSUyA9IFtcbiAgYmluZChTYW1wbGVyKVxuICAgICAgLnRvRmFjdG9yeSgoZHJpdmVyLCBtZXRyaWMsIHJlcG9ydGVyLCB2YWxpZGF0b3IsIHByZXBhcmUsIGV4ZWN1dGUsIG5vdykgPT4gbmV3IFNhbXBsZXIoe1xuICAgICAgICAgICAgICAgICAgIGRyaXZlcjogZHJpdmVyLFxuICAgICAgICAgICAgICAgICAgIHJlcG9ydGVyOiByZXBvcnRlcixcbiAgICAgICAgICAgICAgICAgICB2YWxpZGF0b3I6IHZhbGlkYXRvcixcbiAgICAgICAgICAgICAgICAgICBtZXRyaWM6IG1ldHJpYyxcbiAgICAgICAgICAgICAgICAgICAvLyBUT0RPKHRib3NjaCk6IERJIHJpZ2h0IG5vdyBkb2VzIG5vdCBzdXBwb3J0IG51bGwvdW5kZWZpbmVkIG9iamVjdHNcbiAgICAgICAgICAgICAgICAgICAvLyBNb3N0bHkgYmVjYXVzZSB0aGUgY2FjaGUgd291bGQgaGF2ZSB0byBiZSBpbml0aWFsaXplZCB3aXRoIGFcbiAgICAgICAgICAgICAgICAgICAvLyBzcGVjaWFsIG51bGwgb2JqZWN0LCB3aGljaCBpcyBleHBlbnNpdmUuXG4gICAgICAgICAgICAgICAgICAgcHJlcGFyZTogcHJlcGFyZSAhPT0gZmFsc2UgPyBwcmVwYXJlIDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICBleGVjdXRlOiBleGVjdXRlLFxuICAgICAgICAgICAgICAgICAgIG5vdzogbm93XG4gICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICAgV2ViRHJpdmVyQWRhcHRlcixcbiAgICAgICAgICAgICAgICAgICBNZXRyaWMsXG4gICAgICAgICAgICAgICAgICAgUmVwb3J0ZXIsXG4gICAgICAgICAgICAgICAgICAgVmFsaWRhdG9yLFxuICAgICAgICAgICAgICAgICAgIE9wdGlvbnMuUFJFUEFSRSxcbiAgICAgICAgICAgICAgICAgICBPcHRpb25zLkVYRUNVVEUsXG4gICAgICAgICAgICAgICAgICAgT3B0aW9ucy5OT1dcbiAgICAgICAgICAgICAgICAgXSlcbl07XG4iXX0=